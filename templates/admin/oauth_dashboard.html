{% extends "admin/base_site.html" %}
{% load i18n admin_urls static admin_modify %}

{% block title %}OAuth & Calendar Integration Dashboard{% endblock %}

{% block extrahead %}
{{ block.super }}
<style>
.oauth-dashboard {
    max-width: 1200px;
    margin: 0 auto;
    padding: 20px;
}

.status-card {
    background: white;
    border: 1px solid #ddd;
    border-radius: 8px;
    padding: 20px;
    margin-bottom: 20px;
    box-shadow: 0 2px 4px rgba(0,0,0,0.1);
}

.status-card h3 {
    margin-top: 0;
    color: #333;
    border-bottom: 2px solid #007cba;
    padding-bottom: 10px;
}

.status-grid {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
    gap: 20px;
    margin-bottom: 20px;
}

.integration-item {
    background: #f8f9fa;
    border: 1px solid #dee2e6;
    border-radius: 6px;
    padding: 15px;
    margin-bottom: 10px;
}

.integration-item.valid {
    border-left: 4px solid #28a745;
}

.integration-item.invalid {
    border-left: 4px solid #ffc107;
}

.integration-item.none {
    border-left: 4px solid #dc3545;
}

.status-badge {
    display: inline-block;
    padding: 4px 8px;
    border-radius: 4px;
    font-size: 12px;
    font-weight: bold;
    text-transform: uppercase;
}

.status-badge.valid {
    background: #d4edda;
    color: #155724;
}

.status-badge.invalid {
    background: #fff3cd;
    color: #856404;
}

.status-badge.none {
    background: #f8d7da;
    color: #721c24;
}

.test-section {
    background: #e3f2fd;
    border: 1px solid #bbdefb;
    border-radius: 6px;
    padding: 20px;
    margin-bottom: 20px;
}

.test-section h4 {
    margin-top: 0;
    color: #1976d2;
}

.form-group {
    margin-bottom: 15px;
}

.form-group label {
    display: block;
    margin-bottom: 5px;
    font-weight: bold;
    color: #333;
}

.form-group input,
.form-group select,
.form-group textarea {
    width: 100%;
    padding: 8px 12px;
    border: 1px solid #ddd;
    border-radius: 4px;
    font-size: 14px;
}

.form-group textarea {
    height: 100px;
    resize: vertical;
}

.btn {
    display: inline-block;
    padding: 10px 20px;
    background: #007cba;
    color: white;
    text-decoration: none;
    border-radius: 4px;
    border: none;
    cursor: pointer;
    font-size: 14px;
    margin-right: 10px;
    margin-bottom: 10px;
}

.btn:hover {
    background: #005a87;
}

.btn-success {
    background: #28a745;
}

.btn-success:hover {
    background: #1e7e34;
}

.btn-warning {
    background: #ffc107;
    color: #212529;
}

.btn-warning:hover {
    background: #e0a800;
}

.btn-danger {
    background: #dc3545;
}

.btn-danger:hover {
    background: #c82333;
}

.results-table {
    width: 100%;
    border-collapse: collapse;
    margin-top: 15px;
}

.results-table th,
.results-table td {
    border: 1px solid #ddd;
    padding: 8px 12px;
    text-align: left;
}

.results-table th {
    background: #f8f9fa;
    font-weight: bold;
}

.results-table tr:nth-child(even) {
    background: #f8f9fa;
}

.alert {
    padding: 15px;
    margin-bottom: 20px;
    border: 1px solid transparent;
    border-radius: 4px;
}

.alert-success {
    color: #155724;
    background-color: #d4edda;
    border-color: #c3e6cb;
}

.alert-warning {
    color: #856404;
    background-color: #fff3cd;
    border-color: #ffeaa7;
}

.alert-danger {
    color: #721c24;
    background-color: #f8d7da;
    border-color: #f5c6cb;
}

.alert-info {
    color: #0c5460;
    background-color: #d1ecf1;
    border-color: #bee5eb;
}
</style>
{% endblock %}

{% block content %}
<div class="oauth-dashboard">
    <h1>üîê OAuth & Calendar Integration Dashboard</h1>
    
    {% if messages %}
        {% for message in messages %}
            <div class="alert alert-{{ message.tags }}">{{ message }}</div>
        {% endfor %}
    {% endif %}
    
    <!-- OAuth Configuration Status -->
    <div class="status-card">
        <h3>üìã OAuth Configuration Status</h3>
        {% if oauth_service_configured %}
            <div class="alert alert-success">
                ‚úÖ OAuth service is properly configured with Client ID and Client Secret
            </div>
        {% else %}
            <div class="alert alert-danger">
                ‚ùå OAuth service is not properly configured. Please check environment variables.
            </div>
        {% endif %}
    </div>
    
    <!-- Calendar Integrations Status -->
    <div class="status-card">
        <h3>üìÖ Calendar Integrations Status</h3>
        {% if integration_status %}
            {% for status in integration_status %}
                <div class="integration-item {{ status.has_valid_token|yesno:'valid,invalid,none' }}">
                    <div style="display: flex; justify-content: space-between; align-items: center;">
                        <div>
                            <strong>{{ status.integration.manager.email }}</strong>
                            <br>
                            <small>Calendar ID: {{ status.integration.calendar_id|truncatechars:30 }}</small>
                        </div>
                        <div>
                            {% if status.has_valid_token %}
                                <span class="status-badge valid">Valid Token</span>
                            {% elif status.needs_refresh %}
                                <span class="status-badge invalid">Needs Refresh</span>
                            {% else %}
                                <span class="status-badge none">No Token</span>
                            {% endif %}
                        </div>
                    </div>
                    <div style="margin-top: 10px;">
                        <a href="{% url 'admin:interviews_calendarintegration_change' status.integration.id %}" class="btn">Manage</a>
                        {% if status.needs_refresh %}
                            <a href="?action=refresh&id={{ status.integration.id }}" class="btn btn-warning">Refresh Token</a>
                        {% endif %}
                    </div>
                </div>
            {% endfor %}
        {% else %}
            <div class="alert alert-info">
                No calendar integrations found. Set up OAuth for managers to enable calendar access.
            </div>
        {% endif %}
    </div>
    
    <!-- OAuth Testing Section -->
    <div class="test-section">
        <h4>üß™ OAuth Testing</h4>
        
        <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 20px;">
            <!-- Single Manager OAuth Test -->
            <div>
                <h5>Test Single Manager OAuth</h5>
                <div class="form-group">
                    <label for="manager_email">Manager Email:</label>
                    <input type="email" id="manager_email" name="manager_email" 
                           placeholder="manager@company.com" disabled>
                </div>
                <button type="button" class="btn btn-success" disabled>Test OAuth Setup (Coming Soon)</button>
            </div>
            
            <!-- Bulk OAuth Test -->
            <div>
                <h5>Test Multiple Managers OAuth</h5>
                <div class="form-group">
                    <label for="manager_emails">Manager Emails (one per line):</label>
                    <textarea id="manager_emails" name="manager_emails" 
                              placeholder="manager1@company.com&#10;manager2@company.com&#10;manager3@company.com" disabled></textarea>
                </div>
                <button type="button" class="btn btn-warning" disabled>Test Bulk OAuth (Coming Soon)</button>
            </div>
        </div>
        
        {% if bulk_oauth_results %}
            <h5>Bulk OAuth Results:</h5>
            <table class="results-table">
                <thead>
                    <tr>
                        <th>Manager Email</th>
                        <th>User Created</th>
                        <th>OAuth Status</th>
                        <th>Message</th>
                    </tr>
                </thead>
                <tbody>
                    {% for result in bulk_oauth_results %}
                        <tr>
                            <td>{{ result.email }}</td>
                            <td>{{ result.created|yesno:"Yes,No" }}</td>
                            <td>
                                {% if result.status %}
                                    <span class="status-badge valid">Success</span>
                                {% elif result.requires_auth %}
                                    <span class="status-badge invalid">Needs Auth</span>
                                {% else %}
                                    <span class="status-badge none">Failed</span>
                                {% endif %}
                            </td>
                            <td>{{ result.message }}</td>
                        </tr>
                    {% endfor %}
                </tbody>
            </table>
        {% endif %}
    </div>
    
    <!-- Calendar Availability Testing -->
    <div class="test-section">
        <h4>üìÖ Calendar Availability Testing</h4>
        <div style="display: grid; grid-template-columns: 1fr 1fr 1fr 1fr; gap: 15px;">
            <div class="form-group">
                <label for="manager_email_cal">Manager Email:</label>
                <input type="email" id="manager_email_cal" name="manager_email" 
                       placeholder="manager@company.com" disabled>
            </div>
            <div class="form-group">
                <label for="start_date">Start Date:</label>
                <input type="date" id="start_date" name="start_date" disabled>
            </div>
            <div class="form-group">
                <label for="end_date">End Date:</label>
                <input type="date" id="end_date" name="end_date" disabled>
            </div>
            <div class="form-group">
                <label for="duration_minutes">Duration (min):</label>
                <select id="duration_minutes" name="duration_minutes" disabled>
                    <option value="30">30 minutes</option>
                    <option value="60" selected>60 minutes</option>
                    <option value="90">90 minutes</option>
                    <option value="120">120 minutes</option>
                </select>
            </div>
        </div>
        <button type="button" class="btn btn-success" disabled>Test Calendar Availability (Coming Soon)</button>
        
        {% if calendar_test_result %}
            <h5>Calendar Test Results:</h5>
            <div class="alert alert-success">
                <strong>Manager:</strong> {{ calendar_test_result.manager_email }}<br>
                <strong>Date Range:</strong> {{ calendar_test_result.start_date }} to {{ calendar_test_result.end_date }}<br>
                <strong>Duration:</strong> {{ calendar_test_result.duration_minutes }} minutes<br>
                <strong>Available Slots:</strong> {{ calendar_test_result.slots|length }}
            </div>
            
            {% if calendar_test_result.slots %}
                <table class="results-table">
                    <thead>
                        <tr>
                            <th>Start Time</th>
                            <th>End Time</th>
                            <th>Duration</th>
                        </tr>
                    </thead>
                    <tbody>
                        {% for slot in calendar_test_result.slots %}
                            <tr>
                                <td>{{ slot.start_time|date:"Y-m-d H:i" }}</td>
                                <td>{{ slot.end_time|date:"Y-m-d H:i" }}</td>
                                <td>{{ slot.duration_minutes }} min</td>
                            </tr>
                        {% endfor %}
                    </tbody>
                </table>
            {% endif %}
        {% endif %}
    </div>
    
    <!-- Interview Scheduling Testing -->
    <div class="test-section">
        <h4>üéØ Interview Scheduling Testing</h4>
        <div style="display: grid; grid-template-columns: 1fr 1fr 1fr 1fr; gap: 15px;">
            <div class="form-group">
                <label for="vacancy_id">Vacancy:</label>
                <select id="vacancy_id" name="vacancy_id" disabled>
                    <option value="">Select a vacancy</option>
                </select>
            </div>
            <div class="form-group">
                <label for="start_date_int">Start Date:</label>
                <input type="date" id="start_date_int" name="start_date" disabled>
            </div>
            <div class="form-group">
                <label for="end_date_int">End Date:</label>
                <input type="date" id="end_date_int" name="end_date" disabled>
            </div>
            <div class="form-group">
                <label for="duration_minutes_int">Duration (min):</label>
                <select id="duration_minutes_int" name="duration_minutes" disabled>
                    <option value="30">30 minutes</option>
                    <option value="60" selected>60 minutes</option>
                    <option value="90">90 minutes</option>
                    <option value="120">120 minutes</option>
                </select>
            </div>
        </div>
        <button type="button" class="btn btn-success" disabled>Test Interview Scheduling (Coming Soon)</button>
    </div>
    
    <!-- Recent Interviews -->
    <div class="status-card">
        <h3>üìã Recent Interviews</h3>
        {% if recent_interviews %}
            <table class="results-table">
                <thead>
                    <tr>
                        <th>Candidate</th>
                        <th>Vacancy</th>
                        <th>Manager</th>
                        <th>Scheduled At</th>
                        <th>Status</th>
                        <th>Notifications</th>
                    </tr>
                </thead>
                <tbody>
                    {% for interview in recent_interviews %}
                        <tr>
                            <td>{{ interview.candidate.full_name }}</td>
                            <td>{{ interview.vacancy.title }}</td>
                            <td>{{ interview.manager.email }}</td>
                            <td>{{ interview.scheduled_at|date:"Y-m-d H:i" }}</td>
                            <td>
                                <span class="status-badge {{ interview.status }}">
                                    {{ interview.status|title }}
                                </span>
                            </td>
                            <td>
                                {% if interview.manager_notified and interview.candidate_notified %}
                                    <span class="status-badge valid">Both</span>
                                {% elif interview.manager_notified or interview.candidate_notified %}
                                    <span class="status-badge invalid">Partial</span>
                                {% else %}
                                    <span class="status-badge none">None</span>
                                {% endif %}
                            </td>
                        </tr>
                    {% endfor %}
                </tbody>
            </table>
        {% else %}
            <div class="alert alert-info">
                No interviews found. Schedule some interviews to see them here.
            </div>
        {% endif %}
    </div>
    
    <!-- Quick Actions -->
    <div class="status-card">
        <h3>‚ö° Quick Actions</h3>
        <div>
            <a href="{% url 'admin:interviews_calendarintegration_add' %}" class="btn">Add Calendar Integration</a>
            <a href="{% url 'admin:interviews_interview_changelist' %}" class="btn">View All Interviews</a>
            <a href="{% url 'admin:interviews_interviewslot_changelist' %}" class="btn">View Interview Slots</a>
            <a href="{% url 'admin:vacancies_vacancy_changelist' %}" class="btn">View Vacancies</a>
        </div>
    </div>
</div>

<script>
// Set default dates for testing
document.addEventListener('DOMContentLoaded', function() {
    const today = new Date();
    const nextWeek = new Date(today.getTime() + 7 * 24 * 60 * 60 * 1000);
    const twoWeeksLater = new Date(today.getTime() + 14 * 24 * 60 * 60 * 1000);
    
    const startDateInputs = document.querySelectorAll('input[name="start_date"]');
    const endDateInputs = document.querySelectorAll('input[name="end_date"]');
    
    startDateInputs.forEach(input => {
        input.value = nextWeek.toISOString().split('T')[0];
    });
    
    endDateInputs.forEach(input => {
        input.value = twoWeeksLater.toISOString().split('T')[0];
    });
});
</script>
{% endblock %}
